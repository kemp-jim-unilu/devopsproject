---
- name: Setup git CI server
  hosts: all
  remote_user: vagrant
  become_method: ansible.builtin.sudo

  vars:
    vhome: /home/vagrant
    ci_server_address: 192.168.56.9/gitlab
    # TODO: pass these values into the ruby script
    server_root_password: "r00tr00t"
    server_user_name: "user"
    server_user_password: "us3rus3r"

    registry_addr: "192.168.33.8"
    registry_port: "5000"

  tasks:
  - name: Download and install gitlab
    ansible.builtin.include_role:
      name: gitlab

  - name: Install docker
    ansible.builtin.include_role:
      name: docker

# copying all the scripts into /tmp is better due to problems with permissions
  - name: Copy scripts to vagrant vm
    ansible.builtin.copy:
      src: ./scripts
      dest: /tmp
      mode: u=rwx,g=rwx,o=rwx
    become: true

  - name: Copy initial repo to vagrant vm
    ansible.builtin.copy:
      src: ../data/therepo
      dest: /home/vagrant
      mode: u=rwx,g=rwx,o=rwx
    become: true

  - name: Create artefact repository
    ansible.builtin.file:
      path: "{{ vhome }}/artefact-repository"
      mode: '0777'
      state: directory
    become: true

  - name: Configure gitlab
    ansible.builtin.include_role:
      name: configure-gitlab

  - name: Setup git repo
    ansible.builtin.include_role:
      name: setup-repo

  - name: Configure gitlab runner
    ansible.builtin.include_role:
      name: gitlab-runner

  - name: Configure registry
    ansible.builtin.include_role:
      name: configure-registry
